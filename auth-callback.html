<!DOCTYPE html>
<html>
<head>
  <title>Authentication Callback</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <script>
    // Supabaseの設定
    const supabaseUrl = "https://oytnsshvjsaamyppvpth.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dG5zc2h2anNhYW15cHB2cHRoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjg4MzcxMzgsImV4cCI6MjA0NDQxMzEzOH0.qD3PEJOZAsZ4Zgtp6r6qUqcbp0QMr3-DYe_lTJE1Vko";
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    // 認証状態を取得し、メインウィンドウに送信
    supabaseClient.auth.getSession().then(({ data: { session } }) => {
      alert("Session retrieval started"); // セッション取得開始時
      if (session) {
        alert("Authentication successful. User ID: " + session.user.id + ", Email: " + session.user.email); // 認証成功
        // メインウィンドウにメッセージを送信（window.openerが存在する場合のみ）
        if (window.opener) {
          window.opener.postMessage({ type: 'AUTH_SUCCESS', user: session.user }, '*');
          alert("Sent AUTH_SUCCESS message to main window"); // 成功メッセージ送信後
        } else {
          alert("Main window is not available for messaging.");
        }
      } else {
        alert("Authentication failed"); // 認証失敗
        if (window.opener) {
          window.opener.postMessage({ type: 'AUTH_FAILURE' }, '*');
          alert("Sent AUTH_FAILURE message to main window"); // 失敗メッセージ送信後
        } else {
          alert("Main window is not available for messaging.");
        }
      }
      // 認証が終わったらポップアップを閉じる
      window.close();
    }).catch(error => {
      alert("Error retrieving session: " + error.message); // エラー発生時
      if (window.opener) {
        window.opener.postMessage({ type: 'AUTH_FAILURE' }, '*');
        alert("Sent AUTH_FAILURE message to main window due to error"); // エラーによる失敗メッセージ送信後
      } else {
        alert("Main window is not available for messaging.");
      }
      window.close();
    });
  </script>
</body>
</html>
